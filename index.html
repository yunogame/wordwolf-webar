<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>WordWolf WebAR</title>
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/aframe/mindar-face-aframe.prod.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    #ui {
      position: absolute;
      top: 10px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      padding: 20px;
      border-radius: 10px;
      max-width: 360px;
      width: 90%;
      color: white;
      z-index: 10; /* UIを前面に */
      user-select: none;
    }
    input, button {
      margin-top: 8px;
      padding: 10px;
      font-size: 1em;
      width: 100%;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    #wordDisplay {
      margin-top: 15px;
      font-size: 1.3em;
      min-height: 2em;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="ui">
    <div id="setup">
      <label>参加人数：</label>
      <input type="number" id="playerCount" min="2" max="20" value="4" />
      <button id="createGame">ゲーム作成</button>
      <hr style="margin:10px 0;">
      <label>ゲームID入力して参加</label>
      <input type="text" id="joinGameId" placeholder="ゲームID" />
      <button id="joinGame">参加</button>
    </div>

    <div id="game" style="display:none;">
      <div>ゲームID: <span id="gameIdDisplay"></span></div>
      <button id="showWord">お題を見る</button>
      <div id="wordDisplay"></div>
      <button id="voteButton" style="margin-top:15px; display:none;">投票する</button>
      <button id="endGameButton" style="margin-top:15px; display:none;">ゲーム終了</button>
      <div id="statusMessage" style="margin-top:10px;"></div>
    </div>
  </div>

  <a-scene mindar-face embedded color-space="sRGB" vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: true"
           style="position: fixed; z-index: 1; width: 100vw; height: 100vh;">
    <a-entity mindar-face-target="anchorIndex: 0">
      <a-box color="red" depth="0.1" height="0.1" width="0.1" position="0 0 0" visible="false" id="arModel"></a-box>
    </a-entity>
    <a-camera active="true" position="0 0 0"></a-camera>
  </a-scene>

  <script>
    // Firebase初期化（あなたのfirebaseConfigに差し替えてください）
    const firebaseConfig = {
      apiKey: "AIzaSyBAJQBcqvVUEfmdIaWutofWY2MbfuNoX2c",
      authDomain: "wordwolf-webar.firebaseapp.com",
      databaseURL: "https://wordwolf-webar-default-rtdb.firebaseio.com",
      projectId: "wordwolf-webar",
      storageBucket: "wordwolf-webar.appspot.com",
      messagingSenderId: "422294380099",
      appId: "1:422294380099:web:5df64a14defed9ae487ef6",
      measurementId: "G-XZ7FETM5XF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // グローバル変数
    let playerId = null;
    let gameId = null;
    let totalPlayers = 0;
    let liarIndex = 0;
    let wordSet = [];
    const wordsList = [
      ["りんご", "バナナ"],
      ["サッカー", "野球"],
      ["猫", "犬"],
      ["学校", "会社"],
      ["コーヒー", "紅茶"]
    ];

    // UI要素
    const setupDiv = document.getElementById("setup");
    const gameDiv = document.getElementById("game");
    const gameIdDisplay = document.getElementById("gameIdDisplay");
    const playerCountInput = document.getElementById("playerCount");
    const createGameBtn = document.getElementById("createGame");
    const joinGameBtn = document.getElementById("joinGame");
    const joinGameIdInput = document.getElementById("joinGameId");
    const showWordBtn = document.getElementById("showWord");
    const wordDisplay = document.getElementById("wordDisplay");
    const voteButton = document.getElementById("voteButton");
    const endGameButton = document.getElementById("endGameButton");
    const statusMessage = document.getElementById("statusMessage");

    // プレイヤーが表示済みかの判定用ローカルストレージキー
    const SEEN_KEY = "wordwolf_seen";

    // ゲーム作成
    createGameBtn.addEventListener("click", () => {
      const count = parseInt(playerCountInput.value);
      if(isNaN(count) || count < 2) {
        alert("参加人数は2人以上で入力してください");
        return;
      }
      totalPlayers = count;
      playerId = Date.now().toString(36) + Math.random().toString(36).substring(2);
      gameId = generateGameId();

      // ランダムでワード選択とウルフ位置決定
      wordSet = wordsList[Math.floor(Math.random() * wordsList.length)];
      liarIndex = Math.floor(Math.random() * totalPlayers);

      // Firebaseにゲーム情報を作成
      db.ref(`games/${gameId}`).set({
        totalPlayers: totalPlayers,
        liarIndex: liarIndex,
        wordSet: wordSet,
        players: {},
        status: "waiting"
      }).then(() => {
        joinGameInternal();
      });
    });

    // ゲーム参加
    joinGameBtn.addEventListener("click", () => {
      const joinId = joinGameIdInput.value.trim();
      if(!joinId) {
        alert("ゲームIDを入力してください");
        return;
      }
      gameId = joinId;
      playerId = Date.now().toString(36) + Math.random().toString(36).substring(2);
      joinGameInternal();
    });

    // 内部参加処理
    function joinGameInternal() {
      if(!gameId) return;
      // プレイヤー登録
      const playerRef = db.ref(`games/${gameId}/players/${playerId}`);
      playerRef.set({ seen: false, voted: false })
        .then(() => {
          setupDiv.style.display = "none";
          gameDiv.style.display = "block";
          gameIdDisplay.innerText = gameId;
          showWordBtn.disabled = false;
          voteButton.style.display = "none";
          endGameButton.style.display = "none";
          wordDisplay.innerText = "";
          statusMessage.innerText = "";

          // 監視開始
          setupRealtimeListeners();
        })
        .catch(() => {
          alert("ゲーム参加に失敗しました。ゲームIDを確認してください。");
        });
    }

    // ゲーム情報のリアルタイム監視
    function setupRealtimeListeners() {
      const gameRef = db.ref(`games/${gameId}`);

      gameRef.on("value", (snapshot) => {
        const data = snapshot.val();
        if(!data) {
          alert("ゲームが終了または存在しません。");
          location.reload();
          return;
        }
        totalPlayers = data.totalPlayers;
        liarIndex = data.liarIndex;
        wordSet = data.wordSet;
        const players = data.players || {};
        const status = data.status || "waiting";

        // プレイヤー数チェック
        const playerCountNow = Object.keys(players).length;
        if(status === "waiting" && playerCountNow >= totalPlayers) {
          // 全員参加完了。ゲーム開始へ
          gameRef.update({ status: "started" });
        }

        if(status === "started") {
          statusMessage.innerText = `ゲーム中... 参加者 ${playerCountNow}/${totalPlayers}`;
          voteButton.style.display = "inline-block";
          endGameButton.style.display = "inline-block";
        }

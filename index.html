<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>WordWolf WebAR with Firebase</title>

  <!-- A-FrameやMindARの読み込みはここ -->

  <style>
    body { margin: 0; font-family: sans-serif; }
    #ui {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.6); color: white; padding: 15px; border-radius: 10px;
      display: flex; flex-direction: column; align-items: center;
    }
    button, input { margin-top: 10px; padding: 8px; font-size: 1em; }
  </style>
</head>
<body>

  <div id="ui">
    <label>参加人数：
      <input type="number" id="playerCount" min="2" max="20" value="4">
    </label>
    <button id="startGame">スタート</button>
    <button id="showWord" style="display:none;">お題を見る</button>
    <div id="wordDisplay" style="margin-top:10px;"></div>
  </div>

  <!-- A-Frameシーンなど -->

  <script type="module">
    // Firebaseモジュールの読み込み
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // Firebase設定
    const firebaseConfig = {
      apiKey: "AIzaSyBAJQBcqvVUEfmdIaWutofWY2MbfuNoX2c",
      authDomain: "wordwolf-webar.firebaseapp.com",
      databaseURL: "https://wordwolf-webar-default-rtdb.firebaseio.com",
      projectId: "wordwolf-webar",
      storageBucket: "wordwolf-webar.firebasestorage.app",
      messagingSenderId: "422294380099",
      appId: "1:422294380099:web:5df64a14defed9ae487ef6",
      measurementId: "G-XZ7FETM5XF"
    };

    // Firebase初期化
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // ゲームの基本情報
    const words = [
      ["りんご", "バナナ"],
      ["サッカー", "野球"],
      ["猫", "犬"],
      ["学校", "会社"],
      ["コーヒー", "紅茶"]
    ];

    const startBtn = document.getElementById("startGame");
    const showWordBtn = document.getElementById("showWord");
    const wordDisplay = document.getElementById("wordDisplay");
    const playerCountInput = document.getElementById("playerCount");

    let gameId = null;      // ゲームセッションID
    let playerIndex = null; // 参加者番号（0〜playerCount-1）

    // ホストがゲームを作る（スタートボタン）
    startBtn.addEventListener("click", async () => {
      const count = parseInt(playerCountInput.value);
      if (isNaN(count) || count < 2) {
        alert("2人以上を入力してください");
        return;
      }

      // ゲームIDはランダムに生成（例: timestamp）
      gameId = "game_" + Date.now();

      // お題セットをランダムに選択
      const wordSet = words[Math.floor(Math.random() * words.length)];
      const liarIndex = Math.floor(Math.random() * count);

      // Firebaseにゲームデータを書き込み
      await set(ref(database, 'games/' + gameId), {
        playerCount: count,
        liarIndex: liarIndex,
        wordSet: wordSet,
        players: {}
      });

      playerIndex = 0; // ホストは1人目

      startBtn.style.display = "none";
      playerCountInput.style.display = "none";
      showWordBtn.style.display = "inline-block";
      wordDisplay.textContent = "ゲームを作成しました。お題を見るボタンを押してください。";

      // ここでQRコード表示などを追加するとよいです
      console.log("ゲームID:", gameId);
    });

    // 参加者がQRコード等からgameIdを知っている想定で
    // 簡単な「参加」ボタン処理例（実際はQRスキャンなどでgameIdを取得）
    // ここは別途実装が必要です

    // お題を見るボタン
    showWordBtn.addEventListener("click", async () => {
      if (!gameId) {
        alert("ゲームがまだ開始されていません");
        return;
      }

      // 自分の参加番号をFirebaseに登録（ホストは0、他は参加時に自動登録）
      const playerRef = ref(database, `games/${gameId}/players/player${playerIndex}`);

      // お題データを取得
      const snapshot = await get(ref(database, `games/${gameId}`));
      if (!snapshot.exists()) {
        wordDisplay.textContent = "ゲーム情報が見つかりません";
        return;
      }

      const gameData = snapshot.val();

      // 自分の役割によってお題を決定
      const word = (playerIndex === gameData.liarIndex) ? gameData.wordSet[1] : gameData.wordSet[0];

      wordDisplay.textContent = `あなたのお題：${word}`;

      // Firebaseに「見た」状態を保存しておく
      await set(playerRef, { seen: true, word: word });
      showWordBtn.disabled = true;
    });

    // 他端末はゲームIDを入力するかQRコードでgameIdを読み込む想定
    // 例として簡単な参加処理を関数化（別途UI実装が必要）
    async function joinGame(joinGameId) {
      const snapshot = await get(ref(database, `games/${joinGameId}`));
      if (!snapshot.exists()) {
        alert("ゲームが見つかりません");
        return;
      }
      const gameData = snapshot.val();

      // 空いてる参加番号を探す
      const players = gameData.players || {};
      const count = gameData.playerCount;
      for (let i = 0; i < count; i++) {
        if (!players[`player${i}`]) {
          playerIndex = i;
          break;
        }
      }
      if (playerIndex === null) {
        alert("参加人数が上限に達しています");
        return;
      }

      gameId = joinGameId;

      // 登録だけはしておく（まだお題は見てない状態）
      await set(ref(database, `games/${gameId}/players/player${playerIndex}`), { seen: false });

      startBtn.style.display = "none";
      playerCountInput.style.display = "none";
      showWordBtn.style.display = "inline-block";
      wordDisplay.textContent = "参加しました。お題を見るボタンを押してください。";
      showWordBtn.disabled = false;
    }

    // 例：実際はQRスキャン等でgameIdを取得してjoinGameを呼ぶ
    // joinGame("game_123456789");

  </script>

</body>
</html>
